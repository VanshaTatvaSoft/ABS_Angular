<div class="d-flex justify-content-between align-items-center px-4 mt-3 mb-2">
  <h1 class="text-primary">Breaks</h1>
  <button type="button" class="btn btn-primary" (click)="addBreak()">
    <i class="bi bi-plus-lg me-1"></i> Add Break
  </button>
</div>

<div class="row mx-4 mb-4 g-3">
  <!-- Daily Working Hours -->
  <div class="col-lg-2 col-md-12">
    <div class="daily-hours-card p-3 pb-2 h-100 shadow-sm rounded-3">
      <h6 class="card-title text-primary mb-3 fs-5">Daily Working Hours</h6>
      <div class="d-flex justify-content-between mb-2">
        <span class="label fs-5">Start:</span>
        <span class="value fs-5">{{data!.dailyStartTime | timeFormatPipe:'12hr'}}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span class="label fs-5">End:</span>
        <span class="value fs-5">{{data!.dailyEndTime | timeFormatPipe:'12hr'}}</span>
      </div>
      <hr class="my-2">
      <div class="breaks-list">
        <h6 class="text-muted mb-1">Breaks</h6>
        <div style="height: 130px; overflow-y: auto;">
          <ng-container *ngFor="let brk of data.breakInfoList; let i=index">
            <div class="break-time d-flex justify-content-between align-items-center">
              <div class="fs-6">
                {{ brk.startTime | timeFormatPipe:'12hr'}} - {{ brk.endTime | timeFormatPipe:'12hr'}}
              </div>
              @if(!this.checkCanEdit(brk.startTime | timeFormatPipe:'24hr')){
                <div><i class="fa-solid fa-circle-check text-success fs-5"></i></div>
              }
            </div>
          </ng-container>
        </div>
        @if(breaks.length === 0){
          <div class="text-muted small">No breaks scheduled</div>
        }
      </div>
      <div>
        <div><span class="h6">Total Time - </span>{{totalTimeWorked}}</div>
      </div>
    </div>
  </div>
  <!-- Break Form -->
  <div class="col-lg-10 col-md-12">
    <form [formGroup]="breakForm" (ngSubmit)="submit()">
      <div class="card shadow-sm border-0 p-4 break-card">
        <div formArrayName="breaks" style="max-height: 260px; overflow-y:auto; overflow-x: hidden;">
          <div class="row align-items-center g-3 mb-3" *ngFor="let brk of breaks.controls; let i=index" [formGroupName]="i">

            <!-- Start Time -->
            <div class="col-md-5">
              <div class="form-floating">
                <input type="text"
                       class="form-control"
                       id="startTime{{i}}"
                       formControlName="startTime"
                       placeholder="Start Time"
                       [ngxTimepicker]="startPicker"
                       readonly
                       [ngClass]="{'is-invalid': brk.get('startTime')?.invalid && brk.get('startTime')?.touched}">
                <label for="startTime{{i}}">Start Time</label>
                <ngx-material-timepicker #startPicker (timeSet)="brk.get('startTime')?.setValue($event)"></ngx-material-timepicker>
                <div *ngIf="brk.get('startTime')?.touched && brk.get('startTime')?.hasError('required')" class="text-danger small mt-1">
                  Start time is required
                </div>
                <div *ngIf="brk.get('startTime')?.touched && brk.get('startTime')?.hasError('startTimeInPast')" class="text-danger small mt-1">
                  Start time cannot be in the past
                </div>
                <div *ngIf="brk.errors?.['duplicateStartTime']" class="text-danger small mt-1">
                  Multiple breaks cannot have same start time
                </div>
              </div>
            </div>

            <!-- End Time -->
            <div class="col-md-5">
              <div class="form-floating">
                <input type="text"
                       class="form-control"
                       id="endTime{{i}}"
                       formControlName="endTime"
                       placeholder="End Time"
                       [ngxTimepicker]="endPicker"
                       readonly
                       [ngClass]="{'is-invalid': brk.get('endTime')?.invalid && brk.get('endTime')?.touched}">
                <label for="endTime{{i}}">End Time</label>
                <ngx-material-timepicker #endPicker (timeSet)="brk.get('endTime')?.setValue($event)"></ngx-material-timepicker>
                <div *ngIf="brk.get('endTime')?.touched && brk.get('endTime')?.hasError('required')" class="text-danger small mt-1">
                  End time is required
                </div>
              </div>
            </div>

            <!-- Delete Button -->
            <div class="col-md-2 d-flex justify-content-center align-items-center">
              <button type="button" class="btn btn-outline-danger" (click)="deleteBreak(i, brk)" [disabled]="!brk.get('canEdit')?.value">
                <i class="bi bi-trash"></i>
              </button>
            </div>

            <!-- Validation Errors -->
            <div class="col-12 mt-1">
              @if(brk.errors?.['startAfterEnd']){
                <div class="text-danger small">End time must be after start time</div>
              }
              @if(brk.errors?.['timeSame']){
                <div class="text-danger small">Start and end time cannot be the same</div>
              }
              @if(brk.errors?.['outsideWorkingHours']){
                <div class="text-danger small">
                  Break must be within working hours ({{data.dailyStartTime | timeFormatPipe:'12hr'}} - {{data.dailyEndTime | timeFormatPipe:'12hr'}})
                </div>
              }
              <div *ngIf="brk.errors?.['appointmentConflict'] as conflict" class="text-danger small">
                Break conflicts with appointment: {{conflict.clientName}} ({{conflict.service}}) from {{conflict.startTime | timeFormatPipe:'12hr'}} to {{conflict.endTime | timeFormatPipe:'12hr'}}
              </div>
              @if(brk.errors?.['conflict']){
                <div class="text-danger small">
                  Break conflicts with another break
                </div>
              }
            </div>

          </div>
        </div>

        <!-- Empty state -->
         @if(breaks.length === 0){
           <div class="text-center mt-3 text-muted">
             <i class="bi bi-clock-history fs-1"></i>
             <p class="mt-2">No Breaks Found</p>
           </div>
         }

        <!-- Save Button -->
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-success" [disabled]="!hasChanges() || breakForm.invalid">
            <i class="bi bi-save me-1"></i> Save Breaks
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Appointments -->
<div class="row mx-4 mt-2">
  <div class="col-12">
    @if(data!.myScheduleList!.length){
      <div class="appointment-wrapper">
        <div class="row g-3 p-2" style="max-height: 450px; overflow-y:auto;">
          <div class="col-sm-6 col-md-4 col-lg-3" *ngFor="let appointment of data.myScheduleList; let i=index">
            <div class="custom-card-container" [class.flipped]="flippedCards[i]" (click)="this.flippedCards[i] = !this.flippedCards[i]">
              <div class="custom-card">
                <!-- Card Front -->
                <div class="custom-card-front p-3 d-flex flex-column justify-content-center align-items-center">
                  <h5 class="client-name">{{appointment.clientName}}</h5>
                  <p class="service-name">{{appointment.service}}</p>
                  <span class="badge bg-success fs-6">â‚¹ {{appointment.servicePrice}}</span>
                </div>

                <!-- Card Back -->
                <div class="custom-card-back p-3 d-flex flex-column justify-content-center align-items-start">
                  <p><i class="bi bi-calendar-event me-1"></i> {{appointment.appointmentDate | date:'dd-MM-yyyy'}}</p>
                  <p><i class="bi bi-clock me-1"></i> {{appointment.startTime | timeFormatPipe:'12hr'}} - {{appointment.endTime | timeFormatPipe:'12hr'}}</p>
                  <p><i class="bi bi-info-circle me-1"></i> Status: {{appointment.status}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- No Appointments -->
     @if(!data!.myScheduleList!.length){
       <div class="text-center text-muted mt-3">
         <i class="bi bi-calendar-x fs-1"></i>
         <p class="mt-2">No Appointments Today</p>
       </div>
     }
  </div>
</div>
