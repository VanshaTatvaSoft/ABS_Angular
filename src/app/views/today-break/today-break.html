<div class="d-flex justify-content-between align-items-center px-5 mt-2">
  <h1>Breaks</h1>
  <button type="button" class="btn btn-primary" (click)="addBreak()">
    <i class="bi bi-plus-lg me-1"></i> Add Break
  </button>
</div>

<div class="mx-5 mt-3 row">
  @if(data){
    <div class="col-lg-2 col-md-12">
      <div class="fs-3"><strong>Start Time - </strong>{{data!.dailyStartTime | timeFormatPipe : "12hr"}}</div>
      <div class="fs-3"><strong>End Time - </strong>{{data!.dailyEndTime | timeFormatPipe : "12hr"}}</div>
    </div>
  }
  <div class="col-lg-10 col-md-12">
    <form
      [formGroup]="breakForm"
      (ngSubmit)="submit()"
      *ngIf="breaks.length > 0"
    >
      <div class="card shadow-sm border-0 p-4 row">
        <div
          formArrayName="breaks"
          class="mb-3"
          style="max-height: 230px; overflow-y: auto"
        >
          <div
            class="row align-items-center g-3 mb-3"
            *ngFor="let brk of breaks.controls; let i = index"
            [formGroupName]="i"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex flex-column w-100 justify-content-between align-items-start">
                <!-- input -->
                <div class="d-flex justify-content-between w-100">
                  <!-- Start Time -->
                  <div class="w-100 me-2">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="startTime{{ i }}"
                        formControlName="startTime"
                        placeholder="Start Time"
                        [ngxTimepicker]="startPicker"
                        readonly
                        [ngClass]="{
                          'is-invalid': brk.get('startTime')?.invalid && brk.get('startTime')?.touched
                        }"
                      />
                      <label for="startTime">Start Time</label>
                      <ngx-material-timepicker
                        #startPicker
                        (timeSet)="brk.get('startTime')?.setValue($event)"
                      >
                      </ngx-material-timepicker>
                      <div
                        *ngIf="
                          brk.get('startTime')?.touched &&
                          brk.get('startTime')?.hasError('required')
                        "
                        class="text-danger small mt-1"
                      >
                        Start time is required
                      </div>
                      <div
                        *ngIf="
                          brk.get('startTime')?.touched &&
                          brk.get('startTime')?.hasError('startTimeInPast')
                        "
                        class="text-danger small mt-1"
                      >
                        Start time cannot be in the past
                      </div>
                      <div
                        *ngIf="brk.errors?.['duplicateStartTime']"
                        class="text-danger small mt-1"
                      >
                        Multiple breaks cannot have same start time
                      </div>
                    </div>
                  </div>
                  <!-- End Time -->
                  <div class="w-100 me-2">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="endTime{{ i }}"
                        formControlName="endTime"
                        placeholder="End Time"
                        [ngxTimepicker]="endPicker"
                        readonly
                        [ngClass]="{
                          'is-invalid': brk.get('endTime')?.invalid && brk.get('endTime')?.touched
                        }"
                      />
                      <label for="endTime">End Time</label>
                      <ngx-material-timepicker
                        #endPicker
                        (timeSet)="brk.get('endTime')?.setValue($event)"
                      >
                      </ngx-material-timepicker>
                      <div
                        *ngIf="
                          brk.get('endTime')?.touched &&
                          brk.get('endTime')?.hasError('required')
                        "
                        class="text-danger small mt-1"
                      >
                        End time is required
                    </div>
                    </div>
                  </div>
                  <!-- Delete Button -->
                  <div class="col-1 mt-2">
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="deleteBreak(i, brk)"
                      [disabled]="!brk.get('canEdit')?.value || false"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>

                <!-- validation Error -->
                <div>
                  <div
                    *ngIf="brk.errors?.['startAfterEnd']"
                    class="text-danger small mt-1"
                  >
                    End time must be after start time
                  </div>
                  <div
                    *ngIf="brk.errors?.['timeSame']"
                    class="text-danger small mt-1"
                  >
                    Start and end time cannot be the same
                  </div>
                  <div
                    *ngIf="brk.errors?.['outsideWorkingHours']"
                    class="text-danger small mt-1"
                  >
                    Break must be within working hours ({{data.dailyStartTime | timeFormatPipe : '12hr'}} - {{data.dailyEndTime | timeFormatPipe : '12hr'}})
                  </div>
                  <div
                    *ngIf="brk.errors?.['appointmentConflict'] as conflict"
                    class="text-danger small mt-1"
                  >
                    Break conflicts with appointment:
                    {{ conflict.clientName }} ({{ conflict.service }})
                    from {{ conflict.startTime | timeFormatPipe : '12hr' }}
                    to {{ conflict.endTime | timeFormatPipe : '12hr' }}
                  </div>
                  <div
                    *ngIf="brk.errors?.['conflict'] as conflict"
                    class="text-danger small mt-1"
                  >
                    Break conflicts with another break
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button inside card -->
        <div *ngIf="breaks.length > 0" class="text-end mt-3">
          <button type="submit" class="btn btn-success" [disabled]="!hasChanges() || breakForm.invalid">
            <i class="bi bi-save me-1"></i> Save Breaks
          </button>
        </div>

      </div>
    </form>
    @if(breaks.length == 0){
      <div class="card shadow-sm border-0 p-4 row">
        <div class="d-flex align-items-center justify-content-center">
          <h2>No Breaks Found</h2>
        </div>
      </div>
    }
    <!-- appointment card -->
    <div>
      <div class="appointment-wrapper mt-4" *ngIf="data?.myScheduleList?.length">
        <div class="row" style="max-height: 455px; overflow-y: auto;">
          <div class="col-sm-6 col-md-4 col-lg-3 mb-3"
               *ngFor="let appointment of data.myScheduleList; let i = index">
            <div class="custom-card-container"
                 [class.flipped]="flippedCards[i]"
                 (click)="toggleCard(i)">
              <div class="custom-card">
                <!-- Card Front -->
                <div class="custom-card-front">
                  <h5 class="client-name">{{ appointment.clientName }}</h5>
                  <p class="service-name">{{ appointment.service }}</p>
                  <span class="price-tag">â‚¹ {{ appointment.servicePrice }}</span>
                </div>

                <!-- Card Back -->
                <div class="custom-card-back">
                  <p><strong>Date:</strong> {{ appointment.appointmentDate | date:'dd-MM-yyyy' }}</p>
                  <p><strong>Start:</strong> {{ appointment.startTime | timeFormatPipe : "12hr"  }}</p>
                  <p><strong>End:</strong> {{ appointment.endTime | timeFormatPipe : "12hr"  }}</p>
                  <p><strong>Status:</strong> {{ appointment.status }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
